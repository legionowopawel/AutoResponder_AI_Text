function checkMail() {
  // 0. Sprawdzenie limit√≥w Gmail
  try {
    GmailApp.getInboxUnreadCount();
  } catch (e) {
    GmailApp.sendEmail(
      "pawlawiecka@gmail.com",
      "Autoresponder ‚Äì Gmail zablokowany",
      "Gmail osiƒÖgnƒÖ≈Ç limit. Zmniejsz czƒôstotliwo≈õƒá triggera.\n\nSzczeg√≥≈Çy:\n" + e
    );
    return;
  }

  // 1. Lista dozwolonych emaili (normalizowana)
  const allowed = [
    "archiwumkota@gmail.com",
    "aniasadowska11@gmail.com",
    "marekzielinskixyz@gmail.com",
    "sopor@op.pl",
    "piotrsoporowski@gmail.com",
    "matelaxyz@gmail.com",
    "czeczekm@gmail.com",
    "persecyfr@gmail.com",
    "ooooooooohhhhhhhhhooooooooo@gmail.com",
    "luczak@zoliborznotariusze.pl",
    "gdziesamojepieniadzepytam@gmail.com",
    "episiewicz@gmail.com",
    "archiwummoniki@gmail.com"
  ].map(e => normalizeEmail(e));

  // 2. Pobieramy nieprzeczytane maile z ostatnich 5 godzin
  const query = 'is:unread newer_than:5h -label:processed';
  const MAX_THREADS = 15;
  const threads = GmailApp.search(query).slice(0, MAX_THREADS);

  threads.forEach(thread => {
    const messages = thread.getMessages();
    const msg = messages[messages.length - 1];

    // Pobieramy nadawcƒô
    let rawFrom = msg.getFrom();
    let from = rawFrom.match(/<(.+?)>/)?.[1] || rawFrom;
    from = normalizeEmail(from);

    Logger.log("FROM: " + from);

    // 3. Je≈õli nadawca NIE jest na li≈õcie ‚Üí ignorujemy
    if (!allowed.includes(from)) {
      Logger.log("IGNORED ‚Äì not allowed: " + from);
      msg.markRead();
      thread.addLabel(GmailApp.createLabel("processed"));
      return;
    }

    const subject = msg.getSubject() || "";
    const body = msg.getPlainBody() || "";

    // 4. Je≈õli tre≈õƒá pusta ‚Üí nie wo≈Çamy webhooka
    if (!body.trim()) {
      GmailApp.sendEmail(
        "pawlawiecka@gmail.com",
        "Autoresponder ‚Äì pusty email",
        "Odebrano pustƒÖ wiadomo≈õƒá.\n\nNadawca: " +
          from +
          "\nTemat: " +
          subject +
          "\n\nAI nie zosta≈Ço wywo≈Çane."
      );
      msg.markRead();
      thread.addLabel(GmailApp.createLabel("processed"));
      return;
    }

    // 5. Wywo≈Çanie webhooka z RETRY (3 pr√≥by)
    const payload = {
      from: from,
      subject: subject,
      body: body
    };

    let responseJson = null;
    let success = false;

    // üî• TU JEST POPRAWNY LINK DO TWOJEGO NOWEGO PROJEKTU
    const WEBHOOK_URL = "https://autoresponder-tresc-obrazek-zalacznik.onrender.com/webhook";

    for (let attempt = 1; attempt <= 3; attempt++) {
      Logger.log("Webhook attempt " + attempt);

      const response = UrlFetchApp.fetch(WEBHOOK_URL, {
        method: "post",
        contentType: "application/json",
        payload: JSON.stringify(payload),
        muteHttpExceptions: true
      });

      const text = response.getContentText();
      Logger.log("WEBHOOK RAW RESPONSE: " + text);

      try {
        responseJson = JSON.parse(text);
      } catch (e) {
        Logger.log("JSON parse error: " + e);
      }

      // Retry tylko przy b≈Çƒôdach technicznych
      if (!responseJson || response.getResponseCode() >= 500) {
        Logger.log("Backend error or no JSON ‚Äì retrying...");
        Utilities.sleep(2000);
        continue;
      }

      success = true;
      break;
    }

    if (!success) {
      GmailApp.sendEmail(
        "pawlawiecka@gmail.com",
        "Autoresponder ‚Äì backend nie odpowiada",
        "Backend nie zwr√≥ci≈Ç poprawnej odpowiedzi po 3 pr√≥bach.\n\nNadawca: " +
          from +
          "\nTemat: " +
          subject
      );
      msg.markRead();
      thread.addLabel(GmailApp.createLabel("processed"));
      return;
    }

    // 6. Wysy≈Çamy odpowied≈∫ do nadawcy
    if (responseJson && responseJson.status === "ok") {
      GmailApp.sendEmail(
        from,
        "Re: " + subject,
        responseJson.reply
      );
    }

    // 7. Oznaczamy jako przetworzone
    msg.markRead();
    thread.addLabel(GmailApp.createLabel("processed"));
  });
}


// -----------------------------
// Normalizacja Gmail
// -----------------------------
function normalizeEmail(email) {
  email = email.toLowerCase().trim();
  if (email.endsWith("@gmail.com")) {
    let [local, domain] = email.split("@");
    local = local.replace(/\./g, ""); // usu≈Ñ kropki
    local = local.replace(/\+.*/, ""); // usu≈Ñ aliasy
    return local + "@" + domain;
  }
  return email;
}
